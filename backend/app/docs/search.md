# Полнотекстовый поиск в системе

## Настройка полнотекстового поиска

Система использует возможности PostgreSQL для полнотекстового поиска. Для корректной работы необходимо:

1. Создать полнотекстовые индексы в базе данных
2. Заполнить поисковые векторы для существующих записей

### Создание полнотекстовых индексов

Для создания индексов необходимо выполнить миграционный скрипт:

```bash
cd backend
poetry run python app/migrations/create_search_indices.py
```

Скрипт создает:
- GIN-индексы для таблиц books, authors, categories и tags
- Триггеры для автоматического обновления поисковых векторов при вставке или обновлении записей

### Обновление поисковых векторов для существующих записей

Для заполнения поисковых векторов существующих записей можно:

1. Использовать API-метод:
```
POST /search/update-vectors
```
Требуются права администратора.

2. Запустить миграционный скрипт, который также обновит векторы.

## Доступные методы API для поиска

### Базовый полнотекстовый поиск

```
GET /search/?q={поисковый_запрос}&limit={количество_результатов}&field={поле}
```

Параметры:
- `q` - поисковый запрос (минимум 3 символа)
- `limit` - максимальное количество результатов (по умолчанию 10, максимум 50)
- `field` - опциональное поле для поиска (`title` или `description`, по умолчанию поиск по всем полям)

Пример запроса:
```
GET /search/?q=программирование&limit=20
```

### Поиск по конкретному полю

```
GET /search/field/{field_name}?q={поисковый_запрос}&limit={количество_результатов}
```

Параметры:
- `field_name` - название поля (`title`, `description`, `publisher`, `isbn`)
- `q` - поисковый запрос (минимум 3 символа)
- `limit` - максимальное количество результатов (по умолчанию 10, максимум 50)

Пример запроса:
```
GET /search/field/title?q=алгоритмы&limit=15
```

### Поиск по автору

```
GET /search/by-author?name={имя_автора}&limit={количество_результатов}
```

Параметры:
- `name` - имя автора (минимум 3 символа)
- `limit` - максимальное количество результатов (по умолчанию 20, максимум 100)

Пример запроса:
```
GET /search/by-author?name=Толстой&limit=30
```

### Расширенный поиск

```
GET /search/advanced?q={поисковый_запрос}&title={название}&author={автор}&category={категория}&tag={тег}&limit={количество_результатов}
```

Параметры:
- `q` - основной поисковый запрос (минимум 3 символа)
- `title` - опциональный фильтр по названию
- `author` - опциональный фильтр по автору
- `category` - опциональный фильтр по категории
- `tag` - опциональный фильтр по тегу
- `limit` - максимальное количество результатов (по умолчанию 10, максимум 50)

Пример запроса:
```
GET /search/advanced?q=программирование&author=Кнут&category=Компьютеры&limit=20
```

### Подсказки для поиска

```
GET /search/suggest?q={поисковый_запрос}
```

Параметры:
- `q` - поисковый запрос (минимум 3 символа)

Возвращает список строк с возможными исправлениями или дополнениями для поискового запроса.

Пример запроса:
```
GET /search/suggest?q=програмирование
```

Может вернуть: `["программирование", "программирования", "программист"]`

### Обновление поисковых векторов

```
POST /search/update-vectors
```

Требуются права администратора.

## Особенности поиска

### Поддержка операторов логики

Система поддерживает следующие операторы логики:
- `&` (AND): слово1 & слово2
- `|` (OR): слово1 | слово2
- `!` (NOT): !слово

Пример:
```
GET /search/?q=программирование & алгоритмы
```

### Поиск фраз

Для поиска точных фраз используйте кавычки:

```
GET /search/?q="структуры данных"
```

### Поддержка морфологии русского языка

Система поддерживает поиск с учетом морфологии русского языка. Можно использовать суффикс `:*` для поиска всех словоформ:

```
GET /search/?q=книг:*
```

Найдет "книга", "книги", "книгой" и т.д.

Если операторы логики не указаны, система автоматически добавляет поддержку морфологии к каждому слову.

## Технические детали реализации

### Индексы и весовые коэффициенты

Система использует:
- Индексы GIN (Generalized Inverted Index) для быстрого полнотекстового поиска
- Весовые коэффициенты для разных полей:
  - A (наивысший): title
  - B (высокий): description
  - C (средний): isbn
  - D (низкий): publisher

### Ранжирование результатов

Результаты сортируются по релевантности с использованием функций:
- `ts_rank` - базовое ранжирование
- `ts_rank_cd` - ранжирование с учетом плотности и покрытия

### Обработка ошибок

При возникновении ошибок синтаксиса в поисковом запросе система автоматически переходит на запасной вариант поиска, используя оператор `|` (OR) вместо `&` (AND).

## Тестирование поиска

Примеры запросов для тестирования:

```bash
# Базовый поиск
curl -X GET "http://localhost:8000/search/?q=программирование" -H "accept: application/json"

# Поиск по автору
curl -X GET "http://localhost:8000/search/by-author?name=Толстой" -H "accept: application/json"

# Поиск по конкретному полю
curl -X GET "http://localhost:8000/search/field/title?q=алгоритмы" -H "accept: application/json"

# Расширенный поиск
curl -X GET "http://localhost:8000/search/advanced?q=программирование&author=Кнут" -H "accept: application/json"

# Подсказки для поиска
curl -X GET "http://localhost:8000/search/suggest?q=програмирование" -H "accept: application/json"

# Поиск с оператором логики
curl -X GET "http://localhost:8000/search/?q=программирование%20%26%20алгоритмы" -H "accept: application/json"

# Поиск фразы
curl -X GET "http://localhost:8000/search/?q=%22структуры%20данных%22" -H "accept: application/json"

# Поиск с учетом морфологии
curl -X GET "http://localhost:8000/search/?q=книг:*" -H "accept: application/json"
```
